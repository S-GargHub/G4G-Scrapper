version: 2.1
jobs:
  build:
    docker:
      - image: circleci/python:3
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build and push Docker image
          command: |
            docker build -t g4g-profile-scrapper:latest .
            echo "Username: $DOCKERHUBUSERNAME"
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUBUSERNAME" --password-stdin
            docker image tag g4g-profile-scrapper:latest "$DOCKERHUBUSERNAME"/scrapper:$(git rev-parse --short HEAD)
            docker push sgarg95/scrapper:latest
            docker push sgarg95/scrapper:$(git rev-parse --short HEAD)
  run_tests:
    docker:
      - image: circleci/python:3
    steps:
      - checkout
      # - run:
      #     name: Install Python dependencies
      #     command: |
      #       echo 'export PATH=~$PATH:~/.local/bin' >> $BASH_ENV && source $BASH_ENV
      #       pip install -r requirements.txt
      - run:
          name: Run server
          command: python3 app.py
          background: true
      - run:
          name: Run unit tests
          command: |
            pytest 
      - store_test_results:
          path: test-reports
      - store_artifacts:
          path: test-reports
workflows:
  build_test:
    jobs:
      - build
      - run_tests

      